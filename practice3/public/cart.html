<!--
    Copied from Lexy Dennis' Assignment 1: Invoice page
    Lexy Dennis' Assignment 2 Invoice page
-->

<script src="./products.js" type="text/javascript"></script>
<!-- uses get request for the data in products.js -->

<script>

    var cart = sessionStorage; //sets 'cart' to the local session
    var quantities = []; //create empty variable 'quantities'

    if (cart.length == 0) { //if cart is not empty...
        history.go(-1); // if there is nothing entered in any of the textboxes, send the user back to the page they were at previously to select tour amounts
        alert('Shopping Cart is Empty! Please Select Tour Amounts'); //notice to renter tour amounts
    };

    //function taken from w3 schools
    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie); //decode the cookie
        var ca = decodedCookie.split(';'); //split up string by ';'
        for (var i = 0; i < ca.length; i++) { //split up by names
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    };

    function addItem(theProduct, theIndex) { //function to increase that row's tour amount by 1
        var thisRowQty = parseInt(sessionStorage.getItem(`${theProduct}${theIndex}`)); //parse it
        thisRowQty += 1; //add 1 to number
        sessionStorage.setItem(`${theProduct}${theIndex}`, thisRowQty); //set the new value to session
        window.location.reload(); //reload page to show changes in cart
    };

    function removeItem(theProduct, theIndex) { //function to decrease that row's tour amount by 1
        var thisRowQty = parseInt(sessionStorage.getItem(`${theProduct}${theIndex}`)); //parse it
        if (thisRowQty > 0) { //if it is greater than 0, enable subtract to avoid neg values
            thisRowQty -= 1; //subtract 1
            sessionStorage.setItem(`${theProduct}${theIndex}`, thisRowQty); //add new value to session
            window.location.reload(); //reload page to show changes
        }

    };

    //taken from stackoverflow.com
    function GoBackWithRefresh(event) { //function to go to previous page
        var past = document.referrer;
        var pastPage = past.split('/').pop(); //get value of string after '/' in past page query string

        if (pastPage != 'login.html' && pastPage != 'register.html' && pastPage != 'cart.html') { //if the past page is the login, registration, or cart...
            window.location = past;
        } else if (pastPage == 'login.html' && pastPage == 'register.html' && pastPage == 'cart.html') {
            window.history.go(-2); //go back 2 pages instead of to that last page
        } else {
            window.location.href = './index.html'; //otherwise go to home page
        }
    };

    function checkCart() {
        if (cart.length == 0) {
            window.location.reload();
        } else if (theUsername == '') {
            alert(`Please log in before viewing cart`);
            window.location.href = './login.html';
        } else {
            fetch("/generateInvoice?cartData="+JSON.stringify(cart)+"&cookieData="+JSON.stringify(document.cookie), 
            {
                method: "POST"
            }).then(function (res) {
                return res.text();
            }).then(function (data) {
                document.write(data);
            })
        }
    }

</script>

<!-- Copied from order_page_Ex4.html in Lab13 -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart</title>
   <!--[if lte IE 8]><script src="js/html5shiv.js"></script><![endif]-->
		<script src="js/jquery.min.js"></script>
		<script src="js/skel.min.js"></script>
		<script src="js/skel-layers.min.js"></script>
		<script src="js/init.js"></script>
		<link rel="stylesheet" href="css/skel.css" />
		<link rel="stylesheet" href="css/style.css" />
		<link rel="stylesheet" href="css/style-xlarge.css" />
</head>
<body id="top">

    <!-- Header -->
    <header id="header" class="skel-layers-fixed">
        <h1><a href="index.html">Sustainable Outfitters</a></h1>
        <nav id="nav">
            <ul>
                <li><a href="./index.html">Home</a></li>
                <li><a href="./login.html">Login</a></li>
                <li><a href="./register.html">Register</a></li>
                <li><div class="dropdown">
                    <a class="dropbtn" href="./products_display.html">Products</a>
                    <div class="dropdown-content">
                        <a href="bath.html">Bath</a> <br>
                        <a href="home.html">Home</a> <br>
                        <a href="kitchen.html">Kitchen</a> <br>
                        <a href="kits.html">Kits</a> <br>
                        <a href="extra.html">Extra</a>
                    </div>
                  </div>
                </li>
                <li><a href="./cart.html">Shopping Cart</a></li>
            </ul>
        </nav>
    </header>
  <section id="banner">
    <div class="inner">
    <script> // Above the invoice, thank the user personally by his/her name
        var theUser = getCookie('name'); //theUser is the cookie for user's name
        var theUsername = getCookie('username'); //sets variable for username in cookie
        if (theUsername != '') { //if there is not a name for user but there is a username...
            document.write(`
                <p align="center">Hello, ${theUsername}! Please review your shopping cart order below</p>
                <p align="center">Not ${theUsername}? Please log in <a href="login.html" >here</a></p><br />
            `)
        } else { //if not a cookie for user, prompt to log in
            document.write(`
                <p align="center">You are not logged in: Click <a href="login.html">here</a> to log in</p>
            `)
        };
    </script>
    </div>
    </section>
<br>
    <!-- Table template taken from Invoice1_1 as displayed in the Assignment 1 directions page -->
    <section id="one" class="wrapper style1">
            <!--start of invoice table--> 
      <table>
        <tbody>
            <tr>
                <td style="text-align: left;" width="40%"><strong>Product</strong></td>
                <td width="20%"><strong>Quantity</strong></td>
                <td width="20%"><strong>Price</strong></td>
                <td width="20%"><strong>Extended Price</strong></td>
            </tr>
            <script> //The script will get the information entered on the home page to input into the table

                subtotal = 0; //subtotal starts off as 0
                for (product in allProducts) {
                    for (i = 0; i < allProducts[product].length; i++) {

                        qty = cart.getItem(`${product}${i}`);
                        if (qty > 0) { //if there is a quantity entered in the textbox ...
                            extended_price = qty * allProducts[product][i].price //equation for extended price
                            subtotal += extended_price; //adding extended price for each tour to the subtota

                            document.write(`
                            <tr>
                                <td style= "text-align: left" width="40%">${allProducts[product][i].name}</td>
                                <td width="20%">${qty}
                                    <input type="button" class="button alt" value="+1" onclick="addItem('${product}',${i});">
                                    <input type="button" class="button alt" value="-1" onclick="removeItem('${product}',${i});"></td>
                                <td width="20%">\$${allProducts[product][i].price}</td>
                                <td  width="20%">\$${extended_price}</td>
                            </tr>
                        `);
                        }
                    };
                }
                //compute tax information
                var tax_rate = 0.0471;
                var tax = tax_rate * subtotal; 
                // Compute shipping
                if (subtotal <= 50) {
                    shipping = 2;
                    }
                 else if (subtotal <= 100) {
                  shipping = 5;
                }
                 else {
                  shipping = 0.05 * subtotal; // 5% of subtotal
                  }
                // Compute grand total
                  var total = subtotal + tax + shipping;
            </script>

            <tr>
                <!-- 
                    Creates row of space with "clear all" button
                    Code for clear all button taken from smashingmagazine.com
                -->
                <td align="center" colspan="4" width="100%"><input type="button" class="button special" value="Clear All"
                        onclick="cart.clear(); window.location.reload();">
                </td>

            </tr>

            <tr>
                <td colspan="4" width="100%">&nbsp;</td>
              </tr>
              <tr>
                <td colspan="3" width="67%">Sub-total</td>
                <td width="54%">$<script>document.write(subtotal.toFixed(2));</script></td>
              </tr>
              <tr>
                <td  colspan="3" width="67%"><span>Tax at <script>document.write(100*tax_rate);</script>%</span></td>
                <td width="54%">$<script>document.write(tax.toFixed(2));</script></td>
              </tr>
              <tr>
                  <td  colspan="3" width="67%">Shipping</span></td>
                  <td width="54%">$<script>document.write(shipping.toFixed(2));</script></td>
                </tr>
              <tr>
                <td colspan="3" width="67%"><strong>Total</strong></td>
                <td width="54%"><strong>$<script>document.write(total.toFixed(2));</script></strong></td>
              </tr>
              <tr>
                <td style="text-align: center;" colspan="4"> <strong>OUR SHIPPING POLICY IS: A subtotal $0 - $49.99 will be $2 shipping
                  A subtotal $50 - $99.99 will be $5 shipping
                  Subtotals over $100 will be charged 5% of the subtotal amount</strong>
                </td>
            </tr>
        </tbody>
          </table> 
        </section>
        <!-- 
Purchase button that will redirect to invoice
The following purchase button was copied from Lexy Dennis' Assignment 1 index.html page
-->
<section>
    <div class= end>
<input type="submit" value='Purchase' class="button big special" name="purchase_submit_button" onclick="checkCart()">
<input type="submit" value='Continue Shopping' class="button big special" onclick="GoBackWithRefresh()">
</div>
</section>
</html>